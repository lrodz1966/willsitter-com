<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 30px;
    }
    #reader {
      width: 300px;
      height: 300px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>QR Scanner</h2>
  <div id="reader"></div>

  <script>
    console.log("üöÄ QR Scanner page loaded");

    // Wait for Wix to send a message to start scanning (if embedded)
    window.addEventListener("message", function(event) {
      if (event.data && event.data.action === "startScan") {
        console.log("‚úÖ Received postMessage from Wix to start scanning.");
        startScanner();
      }
    });

    // Allow manual start if page is standalone
    document.addEventListener("DOMContentLoaded", () => {
      // If not in an iframe (i.e., standalone test), auto-start
      if (window.self === window.top) {
        console.log("üß™ Running in standalone mode. Attempting to start scanner...");
        startScanner();
      }
    });

    function startScanner() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          console.log("‚úÖ Camera permission granted");
          // Stop preview stream ‚Äî Html5Qrcode will re-request it
          stream.getTracks().forEach(t => t.stop());

          const html5QrCode = new Html5Qrcode("reader");

          Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length > 0) {
              const cameraId = devices[0].id;
              html5QrCode.start(
                cameraId,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                  console.log("üì¶ QR Code detected:", decodedText);
                  // Send result back to parent if embedded
                  window.parent.postMessage({ qrCode: decodedText }, "*");
                },
                errorMessage => {
                  // console.log("Scan error:", errorMessage); // optional
                }
              ).catch(err => {
                console.error("‚ùå html5QrCode.start() failed:", err);
              });
            } else {
              console.warn("‚ö†Ô∏è No cameras found.");
            }
          }).catch(err => {
            console.error("‚ùå Html5Qrcode.getCameras failed:", err);
          });
        })
        .catch(err => {
          console.error("‚ùå Camera permission denied or unavailable:", err);
        });
    }
  </script>
</body>
</html>

