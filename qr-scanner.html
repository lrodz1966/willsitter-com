<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/html5-qrcode"></script>
  </head>
  <body>
    <div id="reader" style="width: 300px;"></div>
    <script>
      const html5QrCode = new Html5Qrcode("reader");

      // Message listener to start scanner if triggered from Wix
      window.addEventListener("message", (event) => {
        if (event.data.action === "startScan") {
          console.log("✅ Received postMessage from Wix to start scanning.");
          startScanning();
        }
      });

      function startScanning() {
        Html5Qrcode.getCameras().then(devices => {
          if (devices && devices.length > 0) {
            const cameraId = devices[0].id;
            html5QrCode.start(
              cameraId,
              { fps: 10, qrbox: { width: 250, height: 250 } },
              (decodedText) => {
                console.log("✅ QR Code detected: ", decodedText);
                // Send message back to Wix iframe
                window.parent.postMessage({ qrCode: decodedText }, "*");
              },
              (errorMessage) => {
                console.warn("Scan error: ", errorMessage);
              }
            ).catch(err => console.error("QR start error:", err));
          }
        }).catch(err => {
          console.error("❌ Camera error:", err);
        });
      }

      // Auto-start for testing outside Wix
      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
        startScanning();
      }
    </script>
  </body>
</html>

